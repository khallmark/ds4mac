// DS4HIDDevice.iig — DriverKit IOUserHIDDevice subclass interface for DualShock 4
// This is the main driver class that matches against DS4 USB devices,
// reads input reports, and publishes a HID device to IOHIDFamily.
//
// Matching: IOUSBHostInterface with Sony VID (0x054C) and DS4 PIDs.
// The IOKitPersonalities in Info.plist trigger instantiation.

#ifndef DS4HIDDevice_h
#define DS4HIDDevice_h

#include <Availability.h>
#include <DriverKit/IOService.iig>
#include <HIDDriverKit/IOUserHIDDevice.iig>
#include <USBDriverKit/IOUSBHostPipe.iig>

class DS4HIDDevice : public IOUserHIDDevice
{
public:
    // Lifecycle
    virtual bool init() override;
    virtual kern_return_t Start(IOService * provider) override;
    virtual kern_return_t Stop(IOService * provider) override;
    virtual void free() override;

    // HID Device Provider — called by IOHIDFamily to get device metadata
    virtual OSDictionary * newDeviceDescription() override;
    virtual OSData * newReportDescriptor() override;

    // Report handling — intercept reports flowing through the HID subsystem
    virtual kern_return_t getReport(IOMemoryDescriptor      * report,
                                     IOHIDReportType          reportType,
                                     IOOptionBits             options,
                                     uint32_t                 completionTimeout,
                                     OSAction               * action) override;

    virtual kern_return_t setReport(IOMemoryDescriptor      * report,
                                     IOHIDReportType          reportType,
                                     IOOptionBits             options,
                                     uint32_t                 completionTimeout,
                                     OSAction               * action) override;

    // USB interrupt IN completion callback — called when an input report arrives.
    // TYPE() macro generates the dispatch glue for async I/O completion.
    // Signature must match IOUSBHostPipe::CompleteAsyncIO exactly (4 params).
    virtual void inputReportComplete(OSAction    * action,
                                      IOReturn     status,
                                      uint32_t     actualByteCount,
                                      uint64_t     completionTimestamp)
                     TYPE(IOUSBHostPipe::CompleteAsyncIO);

    // Internal methods — LOCALONLY means they are not exported for IPC dispatch
    virtual kern_return_t configureDevice() LOCALONLY;
    virtual kern_return_t startInputPolling() LOCALONLY;
    virtual void          processInputReport(const uint8_t * data, uint32_t length) LOCALONLY;
    virtual kern_return_t sendOutputReport(const uint8_t * data, uint32_t length) LOCALONLY;

    // Copy the current parsed input state into a caller-provided buffer.
    // Uses void* because the IIG parser cannot resolve custom struct types.
    // Note: Not synchronized — caller accepts benign races on diagnostic reads.
    virtual bool copyInputState(void * outBuffer, uint32_t bufferSize) LOCALONLY;

    // IMU Calibration — reads Feature Report 0x02 via USB control transfer.
    // Called once during Start() and stored in IVars. Failure is non-fatal
    // (fallback BMI055 nominal values used).
    virtual kern_return_t readCalibrationData() LOCALONLY;

    // Copy calibration data into caller-provided buffer (sizeof DS4CalibrationData).
    virtual bool copyCalibrationData(void * outBuffer, uint32_t bufferSize) LOCALONLY;

    // Compute calibrated IMU values and copy into caller-provided buffer (sizeof DS4CalibratedIMU).
    virtual bool copyCalibratedIMU(void * outBuffer, uint32_t bufferSize) LOCALONLY;

    // Update IORegistry battery properties when level or charging state changes.
    virtual void updateBatteryProperties() LOCALONLY;
};

#endif /* DS4HIDDevice_h */
